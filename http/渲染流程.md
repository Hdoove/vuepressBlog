### 渲染流程

#### 基本流程

构建DOM树、样式计算、布局阶段、分层、绘制、分块、光栅化、合成。

#### 一、构建DOM树

##### 1.为什么要构建DOM树

这是因为浏览器无法直接理解和使用HTML，所以需要将HTML转换为浏览器能够理解的结构 - DOM树

#### 二、样式计算

样式计算的目的是为了计算出DOM节点中每个元素的具体样式。

##### 1.把CSS转换成浏览器能够理解的结构

和HTML一样，浏览器也是无法理解这些纯文本的CSS样式，所以当渲染引擎接收到CSS文本时，会执行一个转换操作，将CSS文本转换为浏览器可以理解的结构 - styleSheets

##### 2.转换样式表中的属性值，使其标准化

当出现2em、blue、bold这些值时，不容易被浏览器理解，所以需要将所有值转换为浏览器容易理解的、标准化的数值，这个过程就是属性标准化。

2em被解析为32px，red解析为rgb(255,0,0)， bold解析为700 ...

##### 3.计算出DOM树中每个节点的具体样式

这里涉及到了继承规则以及层叠规则

CSS继承就是每个DOM节点都包含有父节点的样式

CSS层叠规则

background/border => 负z-index => block块状视屏盒子 => float浮动盒子 => inline/inline-block 水平盒子 => z-index: auto/0 => 正z-index

样式计算阶段的目的就是为了计算出DOM节点每个元素的具体样式，在计算过程中需要遵守CSS继承和层叠两个规则。

#### 三、布局阶段

布局阶段就是计算出DOM树中可见元素的几何位置

##### 1.创建布局树

在显示之前，我们需要额外的创建一颗只包含可见元素的布局树。

为了创建布局树，浏览器做了两件事：

- 遍历DOM树中的所有可见节点，并把这些节点加到布局树中。
- 而不可见的节点被布局树忽略掉，如head标签下的全部内容，再比如block属性值为none的这些元素等。

##### 2.布局计算

现在我们有了一棵完整的布局树。那么接下来，就要计算布局树节点的坐标位置了。

#### 四、分层

渲染引擎还需要为特定的节点生成专用的图层，并生成一颗对应的布局树。比如复杂的3D转换、页面滚动、或者使用z-index做z轴排序等。

通常情况下，并不是布局树的每个节点都包含一个图层，如果一个节点没有对应的层，那么这个节点就从属于他的父节点的图层。不管怎样，最终每个节点都会直接或间接地从属于一个层。

通常满足下面两点中任意一点的元素就可以被提升为单独的一个图层。

- 拥有层叠上下文属性的元素会被提升为独立的一层。

    明确定位属性的元素、定义透明属性的元素、使用 CSS 滤镜的元素等，都拥有层叠上下文属性。
    
    [参考这篇文章](https://developer.mozilla.org/zh-CN/docs/Web/Guide/CSS/Understanding_z_index/The_stacking_context)
- 需要剪裁（clip）的地方也会被创建为图层

#### 五、图层绘制

在完成图层树的构建之后，渲染引擎会对图层树中的每个图层进行绘制。

渲染引擎会把图层的绘制拆分为很多个小的绘制指令，然后在把这些指令按照殊勋组成一个待绘制列表。

#### 六、栅格化操作

绘制列表只是用来记录绘制顺序和绘制指令的列表，而实际上绘制操作是有绘制引擎中的合成线程来完成的。

首先合成线程会将图层划分为图块，然后合成线程会按照视口附近的图块来有限生成位图，实际生成位图的操作是由栅格化来执行的。所谓栅格化就是指将图块转换为位图，图块是栅格化执行的最小单位。

通常，栅格化的过程都会使用GPU来加速生成，使用GPU生成位图的过程叫做快速栅格化，生成的位图被保存在GPU内存中。

#### 七、合成与显示

一旦所有图块都被光栅化，合成线程就会生成一个绘制图块的命令——“DrawQuad”，然后将该命令提交给浏览器进程。浏览器进程里面有一个叫 viz 的组件，用来接收合成线程发过来的 DrawQuad 命令，然后根据 DrawQuad 命令，将其页面内容绘制到内存中，最后再将内存显示在屏幕上。

### 总结

- 渲染进程将HTML内容转换为了；浏览器能够读懂的DOM树结构。
- 渲染引擎将CSS样式转化为浏览器可以理解的styleSheets，计算出DOM节点的样式。
- 创建布局树，并计算元素的布局信息。
- 对布局树进行分层，并声称分层树。
- 为每个图层生成绘制列表，并提交给合成线程。
- 合成线程将图层进行分块，并在光栅化线程池中将图块转换为位图。
- 合成线程发出绘制图块命令 DrawQuad 给浏览器进程。
- 浏览区进程根据 DrawQuad 消息生成页面，并显示到显示器上。


